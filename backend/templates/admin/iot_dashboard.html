{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}IoT Dashboard{% endblock %}

{% block extrahead %}
<style>
.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 16px;
}

.card .number {
    font-size: 32px;
    font-weight: bold;
    color: #2e7d32;
    margin: 10px 0;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-online { background-color: #4caf50; }
.status-offline { background-color: #f44336; }

.recent-activity {
    margin-top: 30px;
}

.activity-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-time {
    color: #666;
    font-size: 12px;
}
</style>
{% endblock %}

{% block content %}
<h1>IoT Smart System Dashboard</h1>

<div class="dashboard-cards">
    <div class="card">
        <h3>Gateways</h3>
        <div class="number">{{ total_gateways }}</div>
        <div>
            <span class="status-indicator status-online"></span>{{ online_gateways }} Online
            <br>
            <span class="status-indicator status-offline"></span>{{ offline_gateways }} Offline
        </div>
    </div>
    
    <div class="card">
        <h3>Devices</h3>
        <div class="number">{{ total_devices }}</div>
        <div>
            <span class="status-indicator status-online"></span>{{ online_devices }} Online
            <br>
            <span class="status-indicator status-offline"></span>{{ offline_devices }} Offline
        </div>
    </div>
    
    <div class="card">
        <h3>Recent Telemetry</h3>
        <div class="number">{{ recent_telemetry_count }}</div>
        <div>Last 24 hours</div>
    </div>
    
    <div class="card">
        <h3>Device Types</h3>
        {% for device_type in devices_by_type %}
        <div>{{ device_type.type|title }}: {{ device_type.count }}</div>
        {% empty %}
        <div>No devices</div>
        {% endfor %}
    </div>
</div>

<div class="recent-activity">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div class="card">
            <h3>Recent Devices</h3>
            {% for device in recent_devices %}
            <div class="activity-item">
                <div>
                    <strong>{{ device.name|default:device.device_id }}</strong>
                    <br>
                    <small>{{ device.type|title }} - {{ device.gateway.name|default:device.gateway.gateway_id }}</small>
                </div>
                <div class="activity-time">
                    Device #{{ device.id }}
                </div>
            </div>
            {% empty %}
            <div class="activity-item">No recent devices</div>
            {% endfor %}
        </div>
        
        <div class="card">
            <h3>Recent Telemetry</h3>
            {% for telemetry in recent_telemetry_data %}
            <div class="activity-item">
                <div>
                    <strong>{{ telemetry.device.name|default:telemetry.device.device_id }}</strong>
                    <br>
                    <small>
                        {% for key, value in telemetry.payload.items %}
                            {% if key != 'gateway_id' %}
                                {{ key }}: {{ value }}{% if not forloop.last %}, {% endif %}
                            {% endif %}
                        {% endfor %}
                    </small>
                </div>
                <div class="activity-time">
                    {{ telemetry.timestamp|timesince }} ago
                </div>
            </div>
            {% empty %}
            <div class="activity-item">No recent telemetry</div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="recent-activity">
    <div class="card">
        <h3>Gateway Overview</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid #ddd;">
                    <th style="text-align: left; padding: 10px;">Gateway</th>
                    <th style="text-align: left; padding: 10px;">Device Count</th>
                    <th style="text-align: left; padding: 10px;">Last Seen</th>
                    <th style="text-align: left; padding: 10px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for gateway in gateways_with_counts %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">
                        <strong>{{ gateway.name|default:gateway.gateway_id }}</strong>
                        <br>
                        <small>{{ gateway.gateway_id }}</small>
                    </td>
                    <td style="padding: 10px;">{{ gateway.devices_count }}</td>
                    <td style="padding: 10px;">
                        {% if gateway.last_seen %}
                            {{ gateway.last_seen|timesince }} ago
                        {% else %}
                            Never
                        {% endif %}
                    </td>
                    <td style="padding: 10px;">
                        <a href="{% url 'admin:devices_gateway_change' gateway.id %}" style="color: #2e7d32;">Edit</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" style="padding: 10px; text-align: center; color: #666;">No gateways registered</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div style="margin-top: 30px;">
    <a href="{% url 'admin:devices_gateway_changelist' %}" class="button">Manage Gateways</a>
    <a href="{% url 'admin:devices_device_changelist' %}" class="button">Manage Devices</a>
    <a href="{% url 'admin:devices_telemetry_changelist' %}" class="button">View Telemetry</a>
</div>

{% endblock %}
